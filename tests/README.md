# RVD æµ‹è¯•æ–‡æ¡£

æœ¬ç›®å½•åŒ…å« Rust Video Downloader (RVD) çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ã€‚

## æµ‹è¯•ç»“æ„

```
tests/
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â”œâ”€â”€ rvd.toml.example            # æµ‹è¯•é…ç½®æ–‡ä»¶ç¤ºä¾‹
â”œâ”€â”€ rvd.toml                    # å®é™…æµ‹è¯•é…ç½®ï¼ˆéœ€è‡ªè¡Œåˆ›å»ºï¼Œä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼‰
â”œâ”€â”€ test_data/                  # æµ‹è¯•è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ bangumi/               # ç•ªå‰§æµ‹è¯•è¾“å‡º
â”‚   â”œâ”€â”€ danmaku_xml/           # XMLå¼¹å¹•æµ‹è¯•è¾“å‡º
â”‚   â”œâ”€â”€ danmaku_ass/           # ASSå¼¹å¹•æµ‹è¯•è¾“å‡º
â”‚   â”œâ”€â”€ chapters/              # ç« èŠ‚æµ‹è¯•è¾“å‡º
â”‚   â”œâ”€â”€ tv_api/                # TV APIæµ‹è¯•è¾“å‡º
â”‚   â”œâ”€â”€ non_interactive/       # éäº¤äº’å¼æµ‹è¯•è¾“å‡º
â”‚   â”œâ”€â”€ complete/              # å®Œæ•´ä¸‹è½½æµ‹è¯•è¾“å‡º
â”‚   â”œâ”€â”€ multi_page/            # å¤šåˆ†Pæµ‹è¯•è¾“å‡º
â”‚   â””â”€â”€ info_only/             # Info-onlyæ¨¡å¼æµ‹è¯•è¾“å‡º
â”œâ”€â”€ cli_test.rs                # CLIå‚æ•°è§£ææµ‹è¯•
â”œâ”€â”€ core_chapter_test.rs       # ç« èŠ‚åŠŸèƒ½å•å…ƒæµ‹è¯•
â”œâ”€â”€ core_danmaku_test.rs       # å¼¹å¹•åŠŸèƒ½å•å…ƒæµ‹è¯•
â”œâ”€â”€ platform_bilibili_test.rs  # Bilibiliå¹³å°å•å…ƒæµ‹è¯•
â”œâ”€â”€ integration_test.rs        # é›†æˆæµ‹è¯•
â””â”€â”€ e2e_download_test.rs       # ç«¯åˆ°ç«¯ä¸‹è½½æµ‹è¯•ï¼ˆTask 32.1-32.9ï¼‰
```

## æµ‹è¯•ç±»å‹

### 1. å•å…ƒæµ‹è¯•

#### CLI æµ‹è¯• (`cli_test.rs`)
- æµ‹è¯•å‘½ä»¤è¡Œå‚æ•°è§£æ
- æµ‹è¯•åˆ†Pé€‰æ‹©é€»è¾‘
- æµ‹è¯•å‚æ•°éªŒè¯

#### ç« èŠ‚æµ‹è¯• (`core_chapter_test.rs`)
- æµ‹è¯•ç« èŠ‚æ•°æ®ç»“æ„
- æµ‹è¯•ç« èŠ‚ä¿¡æ¯çš„åºåˆ—åŒ–/ååºåˆ—åŒ–

#### å¼¹å¹•æµ‹è¯• (`core_danmaku_test.rs`)
- æµ‹è¯•å¼¹å¹•æ ¼å¼æšä¸¾
- æµ‹è¯•å¼¹å¹•æ•°æ®ç»“æ„

#### Bilibili å¹³å°æµ‹è¯• (`platform_bilibili_test.rs`)
- æµ‹è¯• URL è¯†åˆ«å’Œè§£æ
- æµ‹è¯•æµé€‰æ‹©é€»è¾‘
- æµ‹è¯•ä¸åŒ API æ¨¡å¼
- æµ‹è¯•å„ç§ URL æ ¼å¼ï¼ˆBV/av/ep/ss/cheese/æ”¶è—å¤¹/ç©ºé—´/åˆé›†/ç³»åˆ—ï¼‰

### 2. é›†æˆæµ‹è¯• (`integration_test.rs`)

æµ‹è¯•å„ä¸ªæ¨¡å—çš„é›†æˆï¼š
- è§†é¢‘ä¿¡æ¯è§£æï¼ˆå¸¦/ä¸å¸¦è®¤è¯ï¼‰
- æµä¿¡æ¯è·å–
- å­—å¹•è·å–
- Orchestrator åˆ›å»º
- å°æ–‡ä»¶ä¸‹è½½
- FFmpeg æ£€æŸ¥
- Info-only æ¨¡å¼
- å¤šåˆ†Pé€‰æ‹©
- é”™è¯¯å¤„ç†
- è´¨é‡å’Œç¼–ç ä¼˜å…ˆçº§
- æ–‡ä»¶å‘½åæ¨¡æ¿
- é…ç½®æ–‡ä»¶åŠ è½½

### 3. ç«¯åˆ°ç«¯æµ‹è¯• (`e2e_download_test.rs`)

è¦†ç›– Task 32.1-32.9 çš„æ‰€æœ‰åœºæ™¯ï¼š

#### Task 32.1: VideoType æšä¸¾æ‰©å±•
- âœ… `test_32_1_parse_bvid_url` - BVå·è§£æï¼ˆä½¿ç”¨è®¤è¯ä¿¡æ¯ï¼‰
- âœ… `test_32_1_parse_avid_url` - avå·è§£æï¼ˆä½¿ç”¨è®¤è¯ä¿¡æ¯ï¼‰
- âœ… `test_32_1_parse_multi_page_video` - å¤šåˆ†Pè§†é¢‘è§£æï¼ˆä½¿ç”¨è®¤è¯ä¿¡æ¯ï¼‰

#### Task 32.2: ç•ªå‰§å’Œè¯¾ç¨‹ä¿¡æ¯è·å–
- âœ… `test_32_2_parse_bangumi_by_ep` - ç•ªå‰§epé“¾æ¥è§£æï¼ˆéœ€è¦è®¤è¯ï¼‰
- âœ… `test_32_2_parse_bangumi_by_ss` - ç•ªå‰§ssé“¾æ¥è§£æï¼ˆéœ€è¦è®¤è¯ï¼‰
- âœ… `test_32_2_download_bangumi_single_episode` - ä¸‹è½½ç•ªå‰§å•é›†ï¼ˆéœ€è¦è®¤è¯ï¼‰

#### Task 32.3: æ‰¹é‡ä¸‹è½½ - æ”¶è—å¤¹
- âš ï¸ `test_32_3_parse_favorite_list` - æ”¶è—å¤¹è§£æï¼ˆéœ€è¦æœ‰æ•ˆçš„æ”¶è—å¤¹IDï¼‰

#### Task 32.4: æ‰¹é‡ä¸‹è½½ - UPä¸»ç©ºé—´
- âœ… `test_32_4_parse_space_videos` - UPä¸»ç©ºé—´è§†é¢‘è§£æï¼ˆä½¿ç”¨è®¤è¯ä¿¡æ¯ï¼‰

#### Task 32.5: æ‰¹é‡ä¸‹è½½ - åˆé›†å’Œç³»åˆ—
- âš ï¸ `test_32_5_parse_media_list` - åˆé›†è§£æï¼ˆéœ€è¦æœ‰æ•ˆçš„åˆé›†IDï¼‰
- âš ï¸ `test_32_5_parse_series_list` - ç³»åˆ—è§£æï¼ˆéœ€è¦æœ‰æ•ˆçš„ç³»åˆ—IDï¼‰

#### Task 32.6: TV/APP/å›½é™…ç‰ˆAPIæ”¯æŒ
- ğŸ”• `test_32_6_tv_api_mode` - TV APIæ¨¡å¼ï¼ˆå·²å¿½ç•¥ï¼‰
- ğŸ”• `test_32_6_app_api_mode` - APP APIæ¨¡å¼ï¼ˆå·²å¿½ç•¥ï¼‰
- ğŸ”• `test_32_6_download_with_tv_api` - TV APIä¸‹è½½ï¼ˆå·²å¿½ç•¥ï¼‰

#### Task 32.7: å¼¹å¹•ä¸‹è½½åŠŸèƒ½
- âœ… `test_32_7_download_danmaku_xml` - XMLæ ¼å¼å¼¹å¹•ä¸‹è½½
- âœ… `test_32_7_download_danmaku_ass` - ASSæ ¼å¼å¼¹å¹•ä¸‹è½½

#### Task 32.8: ç« èŠ‚ä¿¡æ¯æå–å’ŒåµŒå…¥
- âœ… `test_32_8_fetch_chapters` - ç« èŠ‚ä¿¡æ¯æå–
- âœ… `test_32_8_download_with_chapters` - ä¸‹è½½å¹¶åµŒå…¥ç« èŠ‚

#### Task 32.9: äº¤äº’å¼æ¨¡å¼
- âœ… `test_32_9_interactive_mode_disabled` - éäº¤äº’å¼æ¨¡å¼ï¼ˆè‡ªåŠ¨é€‰æ‹©ï¼‰

#### ç»¼åˆæµ‹è¯•
- âœ… `test_complete_download_workflow` - å®Œæ•´ä¸‹è½½æµç¨‹
- âœ… `test_multi_page_download` - å¤šåˆ†Pä¸‹è½½
- âœ… `test_info_only_mode` - Info-onlyæ¨¡å¼
- âœ… `test_cleanup_old_files` - æ¸…ç†æ—§æ–‡ä»¶

## é…ç½®æµ‹è¯•ç¯å¢ƒ

### 1. åˆ›å»ºé…ç½®æ–‡ä»¶

å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶å¹¶å¡«å…¥ä½ çš„è®¤è¯ä¿¡æ¯ï¼š

```bash
cp tests/rvd.toml.example tests/rvd.toml
```

ç¼–è¾‘ `tests/rvd.toml`ï¼š

```toml
# é»˜è®¤æ¸…æ™°åº¦ä¼˜å…ˆçº§
default_quality = ["1080P é«˜æ¸…", "720P é«˜æ¸…", "480P æ¸…æ™°"]

# é»˜è®¤ç¼–ç æ ¼å¼ä¼˜å…ˆçº§
default_codec = ["hevc", "avc"]

# ä¸‹è½½çº¿ç¨‹æ•°
thread_count = 4

# è®¤è¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œç”¨äºä¸‹è½½ä¼šå‘˜å†…å®¹ï¼‰
[auth]
# ä»æµè§ˆå™¨è·å–çš„ SESSDATA cookie
cookie = "SESSDATA=your_sessdata_here"

# TV/APP API çš„ access_tokenï¼ˆå¯é€‰ï¼‰
# access_token = "your_access_token_here"

# è·¯å¾„é…ç½®
[paths]
# FFmpeg è·¯å¾„ï¼ˆå¦‚æœä¸åœ¨ç³»ç»Ÿ PATH ä¸­ï¼‰
# ffmpeg = "/usr/local/bin/ffmpeg"
```

### 2. è·å– Cookie

è¦æµ‹è¯•éœ€è¦è®¤è¯çš„åŠŸèƒ½ï¼ˆå¦‚ä¼šå‘˜è§†é¢‘ã€æ”¶è—å¤¹ç­‰ï¼‰ï¼Œéœ€è¦è·å– Bç«™çš„ SESSDATA cookieï¼š

1. åœ¨æµè§ˆå™¨ä¸­ç™»å½• bilibili.com
2. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
3. åˆ‡æ¢åˆ° Application/å­˜å‚¨ æ ‡ç­¾
4. åœ¨ Cookies ä¸­æ‰¾åˆ° `SESSDATA`
5. å¤åˆ¶å…¶å€¼åˆ°é…ç½®æ–‡ä»¶ä¸­

**æ³¨æ„**: æ‰€æœ‰æµ‹è¯•éƒ½ä¼šå°è¯•ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„è®¤è¯ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚å³ä½¿æ˜¯å…¬å¼€è§†é¢‘çš„æµ‹è¯•ï¼Œä½¿ç”¨è®¤è¯ä¿¡æ¯ä¹Ÿå¯ä»¥è·å¾—æ›´å¥½çš„æµ‹è¯•è¦†ç›–ç‡å’Œæ›´ç¨³å®šçš„ç»“æœã€‚

### 3. å®‰è£… FFmpeg

å¤§éƒ¨åˆ†æµ‹è¯•éœ€è¦ FFmpeg è¿›è¡Œæ··æµï¼š

**macOS:**
```bash
brew install ffmpeg
```

**Ubuntu/Debian:**
```bash
sudo apt install ffmpeg
```

**Windows:**
ä» [FFmpegå®˜ç½‘](https://ffmpeg.org/download.html) ä¸‹è½½å¹¶æ·»åŠ åˆ° PATH

## è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cargo test
```

### è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
cargo test --test cli_test
cargo test --test platform_bilibili_test

# è¿è¡Œé›†æˆæµ‹è¯•
cargo test --test integration_test

# è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
cargo test --test e2e_download_test
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹

```bash
# è¿è¡Œç‰¹å®šçš„æµ‹è¯•å‡½æ•°
cargo test test_32_1_parse_bvid_url

# è¿è¡ŒåŒ…å«ç‰¹å®šå…³é”®å­—çš„æµ‹è¯•
cargo test danmaku
```

### è¿è¡Œè¢«å¿½ç•¥çš„æµ‹è¯•

æŸäº›æµ‹è¯•ï¼ˆå¦‚ TV/APP APIï¼‰é»˜è®¤è¢«å¿½ç•¥ï¼Œéœ€è¦ç‰¹æ®Šé…ç½®æ‰èƒ½è¿è¡Œï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ŒåŒ…æ‹¬è¢«å¿½ç•¥çš„
cargo test -- --ignored

# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…æ‹¬æ­£å¸¸å’Œè¢«å¿½ç•¥çš„ï¼‰
cargo test -- --include-ignored
```

### æ˜¾ç¤ºæµ‹è¯•è¾“å‡º

```bash
# æ˜¾ç¤º println! è¾“å‡º
cargo test -- --nocapture

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
cargo test -- --nocapture --test-threads=1
```

## æµ‹è¯•è¶…æ—¶è®¾ç½®

ç«¯åˆ°ç«¯æµ‹è¯•è®¾ç½®äº† 5 åˆ†é’Ÿï¼ˆ300ç§’ï¼‰çš„è¶…æ—¶æ—¶é—´ã€‚å¦‚æœä¸‹è½½è¶…æ—¶ï¼Œæµ‹è¯•ä¼šåˆç†åœæ­¢å¹¶æ ‡è®°ä¸ºé€šè¿‡ï¼ˆåªè¦åŠŸèƒ½æ­£å¸¸ï¼‰ã€‚

å¯ä»¥åœ¨ `e2e_download_test.rs` ä¸­ä¿®æ”¹ `TEST_TIMEOUT_SECS` å¸¸é‡æ¥è°ƒæ•´è¶…æ—¶æ—¶é—´ã€‚

## æµ‹è¯•æ•°æ®æ¸…ç†

æµ‹è¯•ä¼šåœ¨ `tests/test_data/` ç›®å½•ä¸‹ç”Ÿæˆè¾“å‡ºæ–‡ä»¶ã€‚å¯ä»¥æ‰‹åŠ¨æ¸…ç†ï¼š

```bash
rm -rf tests/test_data/*
```

æˆ–è¿è¡Œæ¸…ç†æµ‹è¯•ï¼š

```bash
cargo test test_cleanup_old_files
```

è¯¥æµ‹è¯•ä¼šè‡ªåŠ¨åˆ é™¤è¶…è¿‡ 1 å°æ—¶çš„æ—§æ–‡ä»¶ã€‚

## æµ‹è¯•ç”¨çš„ URL

### æœ‰æ•ˆçš„æµ‹è¯• URL

ä»¥ä¸‹æ˜¯æµ‹è¯•ä¸­ä½¿ç”¨çš„çœŸå®æœ‰æ•ˆçš„ Bç«™é“¾æ¥ï¼š

#### æ™®é€šè§†é¢‘
- `BV1qt4y1X7TW` - BBDown å®˜æ–¹ç¤ºä¾‹è§†é¢‘
- `BV1At41167aj` - å¤šåˆ†Pè§†é¢‘ç¤ºä¾‹
- `BV1xx411c7mD` - çŸ­è§†é¢‘ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰
- `BV1uv411q7Mv` - æœ‰å¼¹å¹•å’Œå­—å¹•çš„è§†é¢‘
- `av170001` - avå·ç¤ºä¾‹

#### ç•ªå‰§
- `https://www.bilibili.com/bangumi/play/ss28341` - é¬¼ç­ä¹‹åˆƒç¬¬ä¸€å­£
- `https://www.bilibili.com/bangumi/play/ss33073` - BBDown æ–‡æ¡£ç¤ºä¾‹
- `https://www.bilibili.com/bangumi/play/ep394750` - å…·ä½“æŸä¸€é›†

#### UPä¸»ç©ºé—´
- `https://space.bilibili.com/1` - Bç«™å®˜æ–¹è´¦å·
- `https://space.bilibili.com/546195` - æŸä¸ªæ´»è·ƒUPä¸»

### éœ€è¦æ›¿æ¢çš„ URL

ä»¥ä¸‹æµ‹è¯•éœ€è¦ä½ æä¾›çœŸå®çš„ IDï¼š

- **æ”¶è—å¤¹**: éœ€è¦ä½ è‡ªå·±çš„æ”¶è—å¤¹ ID å’Œ mid
- **åˆé›†**: éœ€è¦æœ‰æ•ˆçš„åˆé›† ID
- **ç³»åˆ—**: éœ€è¦æœ‰æ•ˆçš„ mid å’Œç³»åˆ— ID

## å¸¸è§é—®é¢˜

### 1. æµ‹è¯•å¤±è´¥ï¼šæ— æ³•æ‰¾åˆ° FFmpeg

**è§£å†³æ–¹æ¡ˆ**: å®‰è£… FFmpeg æˆ–åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè·¯å¾„

### 2. æµ‹è¯•å¤±è´¥ï¼šè®¤è¯é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ `tests/rvd.toml` ä¸­çš„ cookie æ˜¯å¦æœ‰æ•ˆ

### 3. æµ‹è¯•è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**: 
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- å¢åŠ  `TEST_TIMEOUT_SECS` çš„å€¼
- ä½¿ç”¨ `--test-threads=1` å‡å°‘å¹¶å‘

### 4. ç•ªå‰§/ä¼šå‘˜è§†é¢‘æ— æ³•è®¿é—®

**è§£å†³æ–¹æ¡ˆ**: 
- ç¡®ä¿é…ç½®äº†æœ‰æ•ˆçš„ cookie
- ç¡®ä¿è´¦å·æœ‰ç›¸åº”çš„æƒé™ï¼ˆå¤§ä¼šå‘˜ç­‰ï¼‰
- æŸäº›ç•ªå‰§å¯èƒ½æœ‰åœ°åŒºé™åˆ¶

### 5. æ”¶è—å¤¹/åˆé›†æµ‹è¯•å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**: 
- è¿™äº›æµ‹è¯•éœ€è¦æœ‰æ•ˆçš„ ID
- æ›¿æ¢æµ‹è¯•ä»£ç ä¸­çš„ç¤ºä¾‹ ID ä¸ºçœŸå®çš„ ID
- ç¡®ä¿é…ç½®äº†è®¤è¯ä¿¡æ¯

## æŒç»­é›†æˆ

åœ¨ CI ç¯å¢ƒä¸­è¿è¡Œæµ‹è¯•æ—¶ï¼š

```bash
# åªè¿è¡Œä¸éœ€è¦è®¤è¯çš„æµ‹è¯•
cargo test --test cli_test
cargo test --test core_chapter_test
cargo test --test core_danmaku_test
cargo test --test platform_bilibili_test

# è·³è¿‡éœ€è¦ä¸‹è½½çš„ç«¯åˆ°ç«¯æµ‹è¯•
cargo test --test integration_test -- --skip download
```

## è´¡çŒ®æµ‹è¯•

æ·»åŠ æ–°æµ‹è¯•æ—¶è¯·éµå¾ªä»¥ä¸‹è§„èŒƒï¼š

1. **å‘½åè§„èŒƒ**: ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•å‡½æ•°å
2. **æ–‡æ¡£æ³¨é‡Š**: ä¸ºæµ‹è¯•æ·»åŠ æ¸…æ™°çš„æ³¨é‡Šè¯´æ˜æµ‹è¯•ç›®çš„
3. **é”™è¯¯å¤„ç†**: ä½¿ç”¨å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
4. **æ¸…ç†**: æµ‹è¯•åæ¸…ç†ä¸´æ—¶æ–‡ä»¶
5. **è¶…æ—¶**: ä¸ºé•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•è®¾ç½®åˆç†çš„è¶…æ—¶
6. **å¿½ç•¥æ ‡è®°**: å¯¹éœ€è¦ç‰¹æ®Šé…ç½®çš„æµ‹è¯•æ·»åŠ  `#[ignore]`

## æµ‹è¯•è¦†ç›–ç‡

æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡ï¼ˆéœ€è¦å®‰è£… tarpaulinï¼‰ï¼š

```bash
cargo install cargo-tarpaulin
cargo tarpaulin --out Html
```

## å‚è€ƒèµ„æ–™

- [Rust æµ‹è¯•æ–‡æ¡£](https://doc.rust-lang.org/book/ch11-00-testing.html)
- [Tokio æµ‹è¯•æŒ‡å—](https://tokio.rs/tokio/topics/testing)
- [BBDown é¡¹ç›®](https://github.com/nilaoda/BBDown)
- [Bilibili API æ–‡æ¡£](https://github.com/SocialSisterYi/bilibili-API-collect)
