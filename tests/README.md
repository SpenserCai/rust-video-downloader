# RVD 测试文档

本目录包含 RVD (Rust Video Downloader) 项目的所有测试用例。

## 测试结构

### 单元测试

1. **cli_test.rs** - CLI参数解析测试
   - 测试质量优先级解析（默认和自定义）
   - 测试编码优先级解析（默认和自定义）
   - 测试分P选择解析（单个、多个、范围、混合、ALL）
   - 覆盖率：10个测试用例

2. **utils_config_test.rs** - 配置管理测试
   - 测试配置文件加载（存在/不存在）
   - 测试有效和无效的TOML格式
   - 测试部分配置加载
   - 覆盖率：4个测试用例

3. **utils_file_test.rs** - 文件工具测试
   - 测试文件名清理（非法字符、长度限制）
   - 测试文件名模板解析（单P和多P）
   - 测试默认输出路径生成
   - 覆盖率：5个测试用例

4. **platform_bilibili_test.rs** - Bilibili平台测试
   - 测试URL识别（各种B站URL格式）
   - 测试流选择逻辑（按质量、按编码、降级）
   - 测试边界情况（无视频流、无音频流）
   - 覆盖率：6个测试用例

### 集成测试

**integration_test.rs** - 完整流程集成测试
- 测试视频信息解析（有/无认证）
- 测试流信息获取
- 测试字幕获取
- 测试Orchestrator创建
- 覆盖率：5个测试用例

## 运行测试

### 运行所有测试
```bash
cargo test
```

### 运行特定测试文件
```bash
cargo test --test cli_test
cargo test --test integration_test
```

### 运行特定测试用例
```bash
cargo test test_parse_quality_priority_default
```

### 显示测试输出
```bash
cargo test -- --nocapture
```

### 运行测试并显示详细信息
```bash
cargo test -- --show-output
```

## 测试配置

测试使用 `tests/rvd.toml` 配置文件，其中包含：
- 默认质量和编码优先级
- 测试用的认证信息（cookie）
- 线程数等配置

**注意**：集成测试中涉及网络请求的测试会检查配置文件是否存在，如果不存在或未配置认证信息，会跳过相应测试。

## 测试覆盖的需求

根据设计文档，测试覆盖了以下核心功能：

### 已测试功能
- ✅ URL解析（需求 1.1, 1.2）
- ✅ 参数解析（需求 2.1, 2.2, 5.2-5.4）
- ✅ 配置管理（需求 10.1-10.5）
- ✅ 文件名处理（需求 8.1-8.4）
- ✅ 流选择逻辑（需求 2.3）
- ✅ 视频信息解析（需求 1.2）
- ✅ 认证处理（需求 4.1-4.4）

### 测试统计
- 总测试用例数：30个
- 单元测试：25个
- 集成测试：5个
- 测试通过率：100%

## 代码质量检查

### 编译检查
```bash
cargo check --tests
```

### Clippy检查
```bash
cargo clippy --tests -- -D warnings
```

### 格式检查
```bash
cargo fmt --check
```

## 测试最佳实践

1. **隔离性**：每个测试用例独立运行，不依赖其他测试
2. **可重复性**：测试结果应该是确定的和可重复的
3. **快速性**：单元测试应该快速执行（< 1秒）
4. **清晰性**：测试名称清楚地描述测试内容
5. **覆盖性**：测试覆盖正常情况和边界情况

## 未来改进

1. 增加更多边界情况测试
2. 添加性能测试
3. 添加并发下载测试
4. 增加mock服务器测试（避免依赖真实网络）
5. 提高测试覆盖率到80%以上
